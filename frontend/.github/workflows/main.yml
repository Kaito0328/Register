# .github/workflows/main.yml

# ã“ã®è‡ªå‹•åŒ–ãƒ—ãƒ­ã‚»ã‚¹ã®åå‰
name: Expo App CI/CD

# ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’æŒ‡å®š
on:
  # mainãƒ–ãƒ©ãƒ³ãƒã«ã‚³ãƒ¼ãƒ‰ãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸæ™‚
  push:
    branches: [ main ]
  # mainãƒ–ãƒ©ãƒ³ãƒã«å¯¾ã™ã‚‹ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä½œæˆã•ã‚ŒãŸæ™‚
  pull_request:
    branches: [ main ]

# å®Ÿè¡Œã™ã‚‹å…·ä½“çš„ãªä½œæ¥­å†…å®¹
jobs:
  # ã€Œtest-and-buildã€ã¨ã„ã†åå‰ã®ä½œæ¥­
  test-and-build:
    # ã“ã®ä½œæ¥­ã¯ã€Ubuntuï¼ˆLinuxï¼‰ã®æœ€æ–°ç‰ˆã®ä¸Šã§å®Ÿè¡Œã—ã¾ã™
    runs-on: ubuntu-latest

    # ä½œæ¥­ã®ã‚¹ãƒ†ãƒƒãƒ—
    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ä»®æƒ³ç’°å¢ƒã«ã‚³ãƒ”ãƒ¼ã™ã‚‹
      - name: ğŸ“š Checkout repository
        uses: actions/checkout@v4

      # 2. Node.jsã®ç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹ (ãƒãƒ¼ã‚¸ãƒ§ãƒ³18ã‚’æŒ‡å®š)
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # npmã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹ã«ã—ã¦ã€æ¬¡å›ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’é«˜é€ŸåŒ–
          cache: 'npm'

      # 3. Expoã¨EASã®ãƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
      - name: ğŸ”§ Install dependencies
        run: |
          npm install -g expo-cli eas-cli
          npm install

      # 4. ã‚³ãƒ¼ãƒ‰ã®é™çš„è§£æï¼ˆãƒªãƒ³ã‚¿ãƒ¼ï¼‰ã‚’å®Ÿè¡Œã™ã‚‹
      - name: ğŸ’… Run linter
        run: npm run lint

      # 5. ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹
      - name: ğŸ§ª Run tests
        run: npm test

      # 6. EAS Buildã§Androidã‚¢ãƒ—ãƒªã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹
      #    (mainãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸæ™‚ã ã‘å®Ÿè¡Œ)
      - name: ğŸš€ Build with EAS
        # ã“ã®ifæ–‡ã§ã€mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã®æ™‚ã ã‘å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«åˆ¶å¾¡
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: eas build --platform android --non-interactive --profile preview
        env:
          # â˜…â˜…â˜… ã“ã®EXPO_TOKENã¯ã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§è¨­å®šãŒå¿…è¦ã§ã™ â˜…â˜…â˜…
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}